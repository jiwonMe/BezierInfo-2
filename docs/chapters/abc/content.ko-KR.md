# 투영 항등식

드 카스텔죠 알고리즘은 베지에 곡선에 있어서 핵심 알고리즘입니다. 곡선을 분할하는 데만 쓰는 게 아니라 효율적으로 그리는 데도(특히 고차 베지에 곡선의 경우), 그리고 세 점과 접선을 기반으로 곡선을 만드는 데도 사용할 수 있습니다. 특히 이 마지막 기능이 정말 유용한데, 곡선 위의 어떤 점을 "집어서" 끌어다니면서 곡선의 형태를 "변형"할 수 있게 해주기 때문입니다.

어떻게 작동할까요? 간단히 말해: 드 카스텔죠 알고리즘을 거꾸로 실행하는 겁니다!

드 카스텔죠 알고리즘을 역으로 실행하려면 몇 가지 기본적인 것들이 필요합니다. 시작점과 끝점, 우리가 움직이고자 하는 곡선 위의 점(이 점에는 *t* 값이 연관되어 있음), 그리고 지금까지 명시적으로 얘기하지 않았고 제가 아는 한 명시적인 이름도 없는 점인데, 드 카스텔죠 과정에서 곡선 위의 점보다 한 단계 위에 존재하는 점이 필요합니다. 저는 곧 명확해질 이유로 이것을 "A"라고 부릅니다.

그럼 텍스트 대신 그래픽을 사용해서 이 "A"가 어디 있는지 봅시다. 텍스트로는 한계가 있으니까요. 아래 그래픽의 슬라이더를 움직여서 특정 `t` 값이 주어졌을 때 `A` 좌표가 무엇인지 확인해보세요. 다른 좌표들도 함께 보이는데, 이것들을 합치면 그래픽에서 "ratio"라고 부르는 값을 도출할 수 있습니다. 곡선의 점들을 움직이면 A, B, C가 움직이는데, 그 값은 어떻게 될까요?

<div class="figure">

<graphics-element inline={true} title="2차 베지에 곡선의 투영" src="./abc.js" data-type="quadratic">
  <input type="range" min="0" max="1" step="0.01" value="0.5" class="slide-control">
</graphics-element>
<graphics-element inline={true} title="3차 베지에 곡선의 투영" src="./abc.js" data-type="cubic">
  <input type="range" min="0" max="1" step="0.01" value="0.5" class="slide-control">
</graphics-element>

</div>

이 그래픽들은 여러 가지를 보여줍니다.

1. 곡선 구성의 "모자" 꼭대기에 있는 점: 이것을 `A`라고 부르겠습니다
2. 선택한 `t` 값에서의 곡선 위의 점: 이것을 `B`라고 부르겠습니다
3. A를 B를 통과하여 곡선의 시작점과 끝점 사이의 선에 투영해서 얻는 점: 이것을 `C`라고 부르겠습니다
4. 2차와 3차 곡선 모두에서, 드 카스텔죠 알고리즘의 마지막 바로 전 단계를 나타내는 두 점 `e1`과 `e2`: 마지막 단계에서 `(1-t) * e1 + t * e2`로 `B`를 찾습니다
5. 3차 곡선의 경우, `A`와 함께 드 카스텔죠 알고리즘의 첫 단계를 나타내는 점 `v1`과 `v2`도 있습니다. 다음 단계에서 `e1`과 `e2`를 찾습니다

이 세 값 A, B, C를 통해 2차 및 3차 베지에 곡선에 대한 중요한 항등식을 도출할 수 있습니다. 곡선 위의 어떤 점에 대한 `t` 값이 주어졌을 때, A에서 B까지의 거리와 B에서 C까지의 거리의 비율은 고정되어 있습니다. 어떤 `t` 값이 시작점에서 20%, 끝점에서 80% 떨어진 C를 만든다면, _시작점, 끝점, 제어점이 어디 있든 상관없이_ 그 `t` 값에서 `C`는 *항상* 시작점에서 20%, 끝점에서 80% 지점에 위치할 것입니다. 한번 해보세요. 어느 그래픽에서든 곡선 위의 점을 선택하고 다른 모든 점을 움직여보세요. 제어점만 움직이면 시작점과 끝점은 움직이지 않고 C도 그대로고, 시작점이나 끝점을 움직이면 C도 움직이지만 상대적 위치는 변하지 않습니다.

그럼 `C`는 어떻게 계산할까요? C는 항상 시작점과 끝점 사이 어딘가에 있으므로, C에는 이 두 좌표 사이를 보간하는 함수가 있을 겁니다.

\[
  C = u(t) \cdot P_{\textit{start}} + (1-u(t)) \cdot P_{\textit{end}}
\]

`u(t)` 함수가 어떻게 생겼는지 알아내면 끝입니다. 다만 이 `u(t)`는 2차 곡선과 3차 곡선 중 어느 것으로 작업하느냐에 따라 형태가 다르다는 것을 기억해야 합니다. [수학을 풀어보면](https://mathoverflow.net/questions/122257/finding-the-formula-for-bezier-curve-ratios-hull-point-point-baseline) (Boris Zbarsky에게 감사드립니다) 다음 두 공식을 얻습니다.

\[
  u(t)_{\textit{quadratic}} = \frac{(1-t)^2}{t^2 + (1-t)^2}
\]

그리고

\[
  u(t)_{\textit{cubic}} = \frac{(1-t)^3}{t^3 + (1-t)^3}
\]

따라서 시작 좌표와 끝 좌표, 그리고 *t* 값을 알면 `A`나 `B` 좌표를 계산하지 않고도 C를 알 수 있습니다. 사실 비율 함수에 대해서도 같은 일을 할 수 있습니다. `t`의 또 다른 함수로서, 기술적으로는 `A`나 `B`나 `C`가 무엇인지 알 필요가 없습니다. 이것도 `t`의 순수 함수로 표현할 수 있습니다.

`A`, `B`, `C`가 주어졌을 때 다음이 항상 성립한다는 관찰에서 시작합니다.

\[
  \textit{ratio}(t) = \frac{\textit{distance}(B,C)}{\textit{distance}(A,B)} = \textit{Constant}
\]

이것에 대한 수학을 풀면 2차 및 3차 곡선에 대한 다음 두 공식을 볼 수 있습니다.

\[
  ratio(t)_{\textit{quadratic}} = \left | \frac{t^2 + (1-t)^2 - 1}{t^2 + (1-t)^2} \right |
\]

그리고

\[
  ratio(t)_{\textit{cubic}} = \left | \frac{t^3 + (1-t)^3 - 1}{t^3 + (1-t)^3} \right |
\]

이제 강력한 도구들이 생겼습니다. 세 점(시작점, 끝점, "곡선 위의 어떤 점")과 `t` 값이 주어지면 곡선을 _구성_할 수 있습니다. 시작점과 끝점, 그리고 `u(t)` 함수를 사용해서 `C`를 계산할 수 있고, `C`를 얻으면 곡선 위의 점(`B`)과 `ratio(t)` 함수를 사용해서 `A`를 찾을 수 있습니다.

\[
  A = B - \frac{C - B}{\textit{ratio}(t)} = B + \frac{B - C}{\textit{ratio}(t)}
\]

`A`를 찾으면, 2차 곡선의 경우 `e1`과 `e2`를 찾는 것은 시작점과 `A` 사이에 `t`로 선형 보간을 실행해서 `e1`을 얻고, `A`와 끝점 사이에서 `e2`를 얻는 문제입니다. 3차 곡선의 경우 `e1`과 `e2` 역할을 할 수 있는 단일 점 쌍은 없습니다(무한히 많은데, B에서의 접선이 3차 곡선의 자유 매개변수이기 때문입니다). 따라서 `e1`에서 `B`까지, `B`에서 `e2`까지의 거리 비율이 베지에 비율 `(1-t):t`인 한, 어떤 쌍이든 자유롭게 선택할 수 있고, 그 후 `v1`과 `v2`를 역산할 수 있습니다.

\[
  \left \{ \begin{aligned}
    e_1 &= (1-t) \cdot v_1 + t \cdot A \\
    e_2 &= (1-t) \cdot A + t \cdot v_2
  \end{aligned} \right .

  \Rightarrow

  \left \{  \begin{aligned}
    v_1 &= \frac{e_1 - t \cdot A}{1-t} \\
    v_2 &= \frac{e_2 - (1-t) \cdot A}{t}
  \end{aligned} \right .
\]

그런 다음 곡선의 제어점을 역산합니다.

\[
  \left \{ \begin{aligned}
    v_1 &= (1-t) \cdot \textit{start} + t \cdot C_1 \\
    v_2 &= (1-t) \cdot C_2 + t \cdot \textit{end}
  \end{aligned} \right .

  \Rightarrow

  \left \{  \begin{aligned}
    C_1 &= \frac{v_1 - (1-t) \cdot \textit{start}}{t} \\
    C_2 &= \frac{v_2 - t \cdot \textit{end}}{1-t}
  \end{aligned} \right .
\]

정리하면: 곡선의 시작점과 끝점, 그리고 곡선이 통과하기를 원하는 세 번째 점 B가 있다면, 어떤 `t` 값에 대해서든 모든 ABC 값을 암묵적으로 알 수 있고, 이것은 (3차 곡선의 경우 적절한 `e1`과 `e2` 좌표에 대한 교육받은 추측과 결합하여) 곡선의 "드 카스텔죠 골격"을 재구성하는 데 필요한 정보를 제공합니다. 즉, 이제 여러 가지를 할 수 있습니다. 세 점만 사용해서 곡선을 "맞출" 수 있고, 곡선 위의 점을 움직이되 시작점과 끝점은 그대로 두고 곡선을 "성형"할 수도 있으며, 곡선 위의 점을 어디로 움직였는지에 따라 곡선을 재구성할 수 있습니다. 이것들은 매우 유용한 기능이며, 다음 몇 섹션에서 둘 다 살펴보겠습니다.
