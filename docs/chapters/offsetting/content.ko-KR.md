# 곡선 오프셋

아마도 저처럼 어떤 방식으로든 베지에 곡선을 사용하는 다양한 작은 프로그램을 작성하다가 어느 시점에 경로 돌출 구현 단계로 넘어갔을 것입니다. 하지만 픽셀 기반으로 하고 싶지 않고 벡터 세계에 머물고 싶습니다. 선을 돌출하는 것은 비교적 쉽고 외곽선을 추적하는 것도 잘 진행되고 있지만(접합 캡과 필렛은 약간 번거롭지만), 제대로 하기로 결정하고 베지에 곡선을 혼합에 추가합니다. 이제 문제가 생겼습니다.

선과 달리 곡률 때문에 베지에 곡선을 복사해서 이리저리 옮기는 것만으로는 단순히 돌출할 수 없습니다. 균일한 두께가 아니라 운이 좋으면 일부 장소에서 너무 얇아 보이는 돌출을 얻게 되지만, 더 가능성이 높은 것은 자기 교차할 것입니다. 그러면 트릭은 곡선을 단순히 복사하는 것이 아니라 확대/축소하는 것입니다. 그런데 베지에 곡선을 어떻게 확대/축소할까요?

결론: **할 수 없습니다**. 그래서 속입니다. 진정한 곡선 확대/축소 또는 곡선 오프셋을 하지 않을 것입니다. 그것은 불가능하기 때문입니다. 대신 '충분히 괜찮아 보이는' 오프셋 곡선을 생성하려고 합니다.

<div class="note">

### "할 수 없다는 게 무슨 말이에요? 증명해보세요."

먼저 "할 수 없다"고 말할 때 실제로 의미하는 것은 "다른 베지에 곡선으로 베지에 곡선을 오프셋할 수 없다"는 것이며, 정말 고차 곡선을 사용하더라도 그렇습니다. 오프셋 곡선을 설명하는 함수를 찾을 수 있지만 다항식이 아니며, 그러므로 다항식이어야 **하는** 베지에 곡선으로 표현할 수 없습니다. 왜 그런지 봅시다.

수학적 관점에서 오프셋 곡선 `O(t)`는 원래 곡선 `B(t)`가 주어졌을 때 `O(t)` 위의 모든 점이 좌표 `B(t)`에서 고정 거리 `d` 떨어진 곡선입니다. 그럼 수학으로 해봅시다.

\[
  O(t) = B(t) + d
\]

하지만 2D에서 작업하고 있고 `d`는 단일 값이므로 벡터로 바꾸고 싶습니다. 곡선 `B(t)`에서 거리 `d` "떨어진" 점을 원한다면 실제로 의미하는 것은 점 `B(t)`에서 `d`곱하기 "법선 벡터"에 있는 점을 원한다는 것입니다. 여기서 "법선"은 `B(t)`에서 접선에 수직("직각으로") 실행되는 벡터입니다. 쉽습니다.

\[
  O(t) = B(t) + d \cdot N(t)
\]

이제 `N(t)`에 대한 공식이 무엇인지 모르면 여전히 그다지 유용하지 않으므로 알아봅시다. `N(t)`는 원래 곡선 접선에 수직으로 실행되고 접선이 단순히 `B'(t)`라는 것을 알고 있으므로 90도 회전하면 끝일 수 있습니다. 하지만 `N(t)`가 모든 `t`에 대해 같은 크기를 가져야 하는지 확인해야 합니다. 그렇지 않으면 오프셋 곡선이 균일한 거리에 있지 않아 전혀 오프셋 곡선이 아닙니다. 이를 보장하는 가장 쉬운 방법은 `N(t)`가 항상 길이 1을 갖도록 하는 것이며, `B'(t)`를 그 크기로 나누어 달성할 수 있습니다.

\[
  N(t) = \bot \left ( \frac{B'(t)}{\left || B'(t) \right || } \right )
\]

일반적으로 이중 세로 막대로 표시되는 `B'(t)`의 크기는 다음 공식으로 주어집니다.

\[
  \left || B'(t) \right || = \sqrt{ B_x'(t)^2 + B_y'(t)^2}
\]

그리고 그게 문제가 되는 곳입니다. 그 제곱근이 모든 것을 망치고 있습니다. 우리의 멋진 다항식을 더 이상 다항식이 아닌 것으로 바꾸기 때문입니다.

제곱근도 다항식인 작은 다항식 클래스가 있지만 우리에게는 완전히 쓸모없습니다. 가중되지 않은 이항 계수를 가진 모든 다항식은 제곱근도 다항식입니다. 이제 베지에 곡선이 이항 계수를 가지므로 괜찮다고 생각할 수 있지만 그렇지 않습니다. **기저** 함수만 이항 계수를 가진다는 것을 기억하세요. 좌표를 인수로 고려하기 전입니다. 좌표를 고려하면 비이항 다각형으로 바뀝니다. 함수가 이항을 유지하도록 하는 유일한 방법은 모든 좌표가 같은 값을 갖도록 하는 것입니다. 그리고 그것은 곡선이 아니라 점입니다. 점에 대한 오프셋 곡선은 이미 만들 수 있으며, 우리는 그것을 원이라고 부르고, 베지에 곡선보다 훨씬 간단한 함수를 가지고 있습니다.

따라서 접선 길이가 다항식이 아니므로 정규화된 접선도 다항식이 아니며, 이는 `N(t)`가 다항식이 아니라는 것을 의미하고, `d`곱하기 `N(t)`도 다항식이 아니라는 것을 의미하며, 궁극적으로 `O(t)`가 다항식이 아니라는 것을 의미합니다. 즉, `O(t)`에 대한 함수를 잘 결정할 수 있더라도(그리고 그것은 사소한 일과는 거리가 멀습니다!) 베지에 곡선으로 표현할 수 없습니다.

그리고 그것이 베지에 곡선이 까다로운 이유 중 하나입니다. 실제로 베지에 곡선으로 전혀 표현할 수 없는 곡선이 *많이* 있습니다. 자신의 오프셋 곡선조차 모델링할 수 없습니다. 그런 면에서 이상합니다. 그렇다면 다른 모든 프로그램은 어떻게 할까요? 글쎄요, 우리가 하려는 것처럼 속입니다. 계산할 수 있다면 실제 오프셋 곡선이 어떻게 보일지 상대적으로 가까워 보이는 방식으로 오프셋 곡선을 근사할 것입니다.

</div>

따라서 다른 베지에 곡선이 얼마나 높은 차수이든 상관없이 다른 베지에 곡선으로 베지에 곡선을 완벽하게 오프셋할 수 없습니다. 하지만 곡선을 "안전한" 하위 곡선으로 잘라낼 수 있습니다(여기서 "안전"은 모든 제어점이 항상 기준선의 한쪽에 있고 `t=0.5`에서 곡선의 중간점이 곡선 좌표로 정의된 다각형의 중심에 대략 있다는 것을 의미함). 그런 다음 각 하위 곡선을 확대/축소 원점(시작 및 끝 점에서 점 법선의 교차점)에 대해 점 확대/축소할 수 있습니다.

이 축소를 수행하는 좋은 방법은 먼저 곡선 극값 섹션에서 설명한 대로 곡선의 극값 점을 찾고 이를 초기 분할 점으로 사용하는 것입니다. 이 초기 분할 후 각 개별 세그먼트를 확인하여 곡선의 중심이 어디에 있는지에 따라 "충분히 안전한지" 확인할 수 있습니다. `t=0.5`에 대한 곡선 위의 점이 중심에서 너무 멀리 떨어져 있으면 세그먼트를 중간에서 분할하기만 하면 됩니다. 일반적으로 이것은 안전한 세그먼트로 끝나기에 충분합니다.

다음 그래픽은 곡선 오프셋을 보여주며 슬라이더를 사용하여 곡선이 오프셋되는 거리를 제어할 수 있습니다. 곡선은 먼저 안전한 세그먼트로 축소된 다음 각각이 원하는 거리만큼 오프셋됩니다. 특히 단순한 곡선의 경우, 특히 2차 곡선에 대해 쉽게 설정할 수 있는 경우 축소가 필요하지 않지만, 곡선이 더 꼬일수록 안전하게 확대/축소할 수 있는 세그먼트를 얻기 위해 곡선을 더 많이 축소해야 합니다.

<graphics-element title="2차 베지에 곡선 오프셋하기" src="./offsetting.js" data-type="quadratic">
  <input type="range" min="5" max="50" step="1" value="20" class="slide-control">
</graphics-element>

<graphics-element title="3차 베지에 곡선 오프셋하기" src="./offsetting.js" data-type="cubic">
  <input type="range" min="5" max="50" step="1" value="20" class="slide-control">
</graphics-element>

곡선을 이동할 때 하위 곡선에 작은 '점프'가 여전히 발생할 수 있음을 알 수 있습니다. 이것은 여전히 순진한 형태의 오프셋을 수행하여 시작 및 끝 점과 같은 거리만큼 제어점을 이동하기 때문입니다. 곡선이 충분히 크면 여전히 잘못된 오프셋으로 이어질 수 있습니다.
